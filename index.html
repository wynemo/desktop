<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>管理软件</title>

    <meta name="description" content="Source code generated using layoutit.com">
    <meta name="author" content="LayoutIt!">

    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script>if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }</script>
    <script src="js/encryption.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/scripts.js"></script>
    <script>if (window.module) module = window.module;</script>
</head>
<body>

<div class="container-fluid">
    <div class="row" id="nav">
        <div class="col-md-12">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a id="manage_nva" class="nav-link active" href="#">管理</a>
                </li>
                <li class="nav-item">
                    <a id="command_nva" class="nav-link " href="#">指令生成</a>
                </li>
                <li class="nav-item">
                    <a id="check_nva" class="nav-link" href="#">核查</a>
                </li>
            </ul>
        </div>
    </div>

    <div class="row" id="manage">
        <div class="col-md-6">
            <div class="row">
                <label for="execute_cmd">执行指令</label>
            </div>
            <div class="row">
                <textarea id="execute_cmd" name="执行指令" rows="5" cols="33" style="width: 90%"></textarea>
            </div>
            <br>
            <div class="row">
                <label for="manage_type">登陆方式</label><select id="manage_type">
                <option value="ssh">ssh</option>
                <option value="telnet">telnet</option>
                </select>
            </div>
            <br>
            <div class="row">
                <button type="button" class="btn btn-success" id="manage_begin">
                    开始执行
                </button>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row">
                <label for="devices">设备列表</label>
            </div>
            <div class="row">
                <textarea id="devices" name="设备列表" rows="5" cols="33" style="width: 90%"></textarea>
            </div>
            <br>
            <div class="row">
                <div class="col-md-6">

                    <button id="export_device" type="button" class="btn btn-success">
                        导出设备
                    </button>
                </div>
                <div class="col-md-6">

                    <button id="import_device" type="button" class="btn btn-success">
                        导入设备
                    </button>
                </div>
            </div>
            <br>
            <div class="row">
                <label for="devices">执行结果</label>
            </div>
            <div class="row">
                <textarea id="remote_results" disabled name="执行结果" rows="5" cols="33" style="width: 90%"></textarea>
                <div id="remote_error"></div>
            </div>
        </div>
    </div>

    <div class="row" id="command">
        <div class="col-md-6">
            <div class="row">
                <label for="command_text">模块</label>
            </div>
            <textarea id="command_text" name="模块"
                      rows="5" cols="33" style="width: 90%"></textarea>
            <div class="row">
                <div class="col-md-4">

                    <button type="button" class="btn btn-success" id="export_command_template">
                        导出
                    </button>
                </div>
                <div class="col-md-4">

                    <button type="button" class="btn btn-success" id="import_command_template">
                        导入
                    </button>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col-md-6">

                    <button type="button" class="btn btn-success" id="command_begin">
                        开始生成
                    </button>
                </div>
            </div>

        </div>
        <div class="col-md-6">
            <div class="row">
                <label for="command_variable">变量</label>
            </div>
            <textarea id="command_variable" name="变量"
                      rows="5" cols="33" style="width: 90%"></textarea>
            <div class="row">
                <div class="col-md-4">

                    <button type="button" class="btn btn-success" id="export_command_variable">
                        导出变量
                    </button>
                </div>
                <div class="col-md-4">

                    <button type="button" class="btn btn-success" id="import_command_variable">
                        导入变量
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="check">
        <!--<div class="row">-->
        <div class="row">
            <div class="col-md-8">
                <button type="button" class="btn btn-info btn-md" id="set_file_path">
                    导入本地数据
                </button>
            </div>
            <div class="col-md-4">
                <label>
                    当前路径
                    <input id="current_path" disabled>
                </label>
            </div>
        </div>
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-6">
                    <div class="row">
                        <label for="check_rules">规则</label>
                    </div>
                    <textarea id="check_rules" name="模块" rows="5" cols="33" style="width: 90%;">
rule:display version

keyword:Patch version : V600R007SPH105
splitword::
calc:==
standard:V600R007SPH105

rule:display version2
keyword:Patch version : V600R007SPH105
splitword::
calc:==
standard:V600R007SPH1051

keyword:yyy
splitword:,
calc:>
stanard:llll
                </textarea>
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-success" id="begin_check">
                                开始核查
                            </button>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-md-4">

                            <button type="button" class="btn btn-success" id="export_rules">
                                导出规则
                            </button>
                        </div>
                        <div class="col-md-4">

                            <button type="button" class="btn btn-success" id="import_rules">
                                导入规则
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <label for="check_result">结果</label>
                    </div>
                    <textarea id="check_result" name="模块" rows="5" cols="33" style="width: 90%"></textarea>
                    <div class="row">
                        <button type="button" class="btn btn-success" id="export_check_result">
                             导出核查结果
                        </button>
                    </div>

                </div>

            </div>
        </div>
        </div>
</div>

<script>
    var remote = require('electron').remote;
    var dialog = remote.dialog;
    const fs = require('fs');
    const app = remote.app;
    const path = require('path');

    const PY_DIST_FOLDER = 'dist'
    const PY_FOLDER = 'pycalc'
    const PY_MODULE = 'check' // without .py suffix

    const guessPackaged = () => {
        const fullPath = path.join(__dirname, PY_DIST_FOLDER)
        return require('fs').existsSync(fullPath)
    }

    const getScriptPath = () => {
        if (!guessPackaged()) {
            return path.join(__dirname, PY_FOLDER, PY_MODULE + '.py')
        }
        if (process.platform === 'win32') {
            return path.join(__dirname, '..', '..', PY_DIST_FOLDER, PY_MODULE + '.exe')
        }
        return path.join(__dirname, '..', '..', PY_DIST_FOLDER, PY_MODULE, PY_MODULE)
    }
    const createPyProc = (rules_path, file_path) => {
        let script = getScriptPath()
        console.log('script', script);
        var path1 = app.getPath('userData');
        console.log(path1);
        if (guessPackaged()) {
            pyProc = require('child_process').execFile(script, [rules_path, file_path])
        } else {
            pyProc = require('child_process').spawn('python', [script, rules_path, file_path])
        }

        if (pyProc != null) {
            //console.log(pyProc)
            $('#check_result').val('');
            var result_text = '';
            pyProc.stdout.on('data', (data) => {
                console.log(`stdout: ${data}`);
                result_text += data;
                $('#check_result').val(result_text);
            } );
            pyProc.stderr.on('data', (data) => {
                console.log(`stderr: ${data}`);
                $('#check_result').val('核查失败');
            });
        }
    }

    function writeInfo() {
        let current_date = Date.now();
        let num = current_date.toString(10);
        let data = encrypt(num);
        console.log(data);
    }

    const getInfoPath = () => {
        if (!guessPackaged()) {
            return path.join(__dirname, PY_FOLDER, 'info.dat')
        }
        return path.join(__dirname, '..', '..', PY_DIST_FOLDER, 'info.dat')
    }

    function refuseWork() {
        console.log('refuse to work');
        throw Error('refuse work')
    }

    $(function () {
        $('#command').hide();
        $('#check').hide();
        $('#manage').show();
        $('#command_nva').on('click', function () {
            $('#command').show();
            $('#check').hide();
            $('#manage').hide();
            $('#check_nva').removeClass('active');
            $('#command_nva').addClass('active');
            $('#manage_nva').removeClass('active');
        })
        $('#check_nva').on('click', function () {
            $('#command').hide();
            $('#check').show();
            $('#manage').hide();
            $('#check_nva').addClass('active');
            $('#command_nva').removeClass('active');
            $('#manage_nva').removeClass('active');
        });
        $('#manage_nva').on('click', function () {
            $('#command').hide();
            $('#check').hide();
            $('#manage').show();
            $('#check_nva').removeClass('active');
            $('#command_nva').removeClass('active');
            $('#manage_nva').addClass('active');
        });

        let info_path = getInfoPath();
        console.log('info_path', info_path);
        if (!fs.existsSync(info_path)) {
            refuseWork();
        } else {
            let data = fs.readFileSync(info_path);
            let info = decrypt(data.toString('utf-8'));
            let span = 3600 * 24 * 30 * 1000;
            console.log(info);
            let date1 = parseInt(info, 10);
            let current_date = Date.now();
            if (current_date <= date1 || current_date - date1 > span) {
                refuseWork();
            }

            let url = 'http://worldtimeapi.org/api/timezone/Asia/Shanghai.json';
            function check() {
                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: url,
                    timeout: 5000,
                    success: function (data, textStatus) {
                        let unix_time = parseInt(data.unixtime, 10);
                        current_date = unix_time * 1000;
                        console.log('current:', current_date);
                        if (current_date <= date1 || current_date - date1 > span) {
                            refuseWork();
                        } else {
                            normalWork();
                        }
                    },
                    fail: function (xhr, textStatus, errorThrown) {
                        refuseWork();
                    }
                });
            }

            function getRandomInt(max) {
                return Math.floor(Math.random() * Math.floor(max));
            }
            if (getRandomInt(100) > 80) {
                check();
            } else {
                normalWork()
            }
        }

        function normalWork() {

            document.getElementById('set_file_path').addEventListener('click', function () {
                dialog.showOpenDialog({ properties: ['openFile', 'openDirectory'] }, function (fileName) {
                    if (fileName === undefined) {
                        console.log("No file selected");
                    } else {
                        console.log("file selected", fileName);
                        $('#current_path').val(fileName);
                    }
                });
            }, false);

            document.getElementById('begin_check').addEventListener('click', function () {
                var content = document.getElementById("check_rules").value;
                let path1 = app.getPath('userData');
                let rules_path = path.join(path1, 'rules.txt');
                console.log(rules_path);
                fs.writeFile(rules_path, content, function (err) {
                    if (err) {
                        alert("An error ocurred creating the file " + err.message)
                        return;
                    }
                    let current_path = $('#current_path').val();
                    console.log('current_path' ,current_path);
                    if (current_path.length === 0 ) {
                        alert('请先选择要检查的文件');
                        return;
                    }
                    createPyProc(rules_path, current_path);
                });
            }, false);

            document.getElementById('command_begin').addEventListener('click', function () {
                var content = '`' + document.getElementById("command_text").value + '`';
                var variable = document.getElementById("command_variable").value;
                eval(variable);
                var o = eval(content);
                document.getElementById("command_text").value = o;
            }, false);

            document.getElementById('export_command_template').addEventListener('click', function () {
                var content = document.getElementById("command_text").value;
                dialog.showSaveDialog(function (fileName) {
                    if (fileName === undefined) {
                        console.log("No file selected");
                    } else {
                        console.log("file selected", fileName);
                        fs.writeFile(fileName, content, function (err) {
                            if (err) {
                                alert("An error ocurred creating the file " + err.message)
                            }

                            alert("The file has been succesfully saved");
                        });
                    }
                });
            }, false);

            document.getElementById('import_command_template').addEventListener('click', function () {
                dialog.showOpenDialog(function (fileNames) {
                    if (fileNames === undefined) {
                        console.log("No file selected");
                    } else {
                        fs.readFile(fileNames[0], 'utf-8', function (err, data) {
                            if (err) {
                                alert("An error ocurred reading the file :" + err.message);
                                return;
                            }
                            document.getElementById("command_text").value = data;
                        });
                    }
                });
            }, false);

            document.getElementById('export_command_variable').addEventListener('click', function () {
                var content = document.getElementById("command_variable").value;
                dialog.showSaveDialog(function (fileName) {
                    if (fileName === undefined) {
                        console.log("No file selected");
                    } else {
                        console.log("file selected", fileName);
                        fs.writeFile(fileName, content, function (err) {
                            if (err) {
                                alert("An error ocurred creating the file " + err.message)
                            }

                            alert("The file has been succesfully saved");
                        });
                    }
                });
            }, false);

            document.getElementById('import_command_variable').addEventListener('click', function () {
                dialog.showOpenDialog(function (fileNames) {
                    if (fileNames === undefined) {
                        console.log("No file selected");
                    } else {
                        fs.readFile(fileNames[0], 'utf-8', function (err, data) {
                            if (err) {
                                alert("An error ocurred reading the file :" + err.message);
                                return;
                            }
                            document.getElementById("command_variable").value = data;
                        });
                    }
                });
            }, false);

            document.getElementById('export_device').addEventListener('click', function () {
                var content = document.getElementById("devices").value;
                dialog.showSaveDialog(function (fileName) {
                    if (fileName === undefined) {
                        console.log("No file selected");
                    } else {
                        console.log("file selected", fileName);
                        fs.writeFile(fileName, content, function (err) {
                            if (err) {
                                alert("An error ocurred creating the file " + err.message)
                            }

                            alert("The file has been succesfully saved");
                        });
                    }
                });
            }, false);

            document.getElementById('import_device').addEventListener('click', function () {
                dialog.showOpenDialog(function (fileNames) {
                    if (fileNames === undefined) {
                        console.log("No file selected");
                    } else {
                        fs.readFile(fileNames[0], 'utf-8', function (err, data) {
                            if (err) {
                                alert("An error ocurred reading the file :" + err.message);
                                return;
                            }
                            document.getElementById("devices").value = data;
                        });
                    }
                });
            }, false);

            document.getElementById('import_rules').addEventListener('click', function () {
                dialog.showOpenDialog(function (fileNames) {
                    if (fileNames === undefined) {
                        console.log("No file selected");
                    } else {
                        fs.readFile(fileNames[0], 'utf-8', function (err, data) {
                            if (err) {
                                alert("An error ocurred reading the file :" + err.message);
                                return;
                            }
                            document.getElementById("check_rules").value = data;
                        });
                    }
                });
            }, false);

            document.getElementById('export_rules').addEventListener('click', function () {
                var content = document.getElementById("check_rules").value;
                dialog.showSaveDialog(function (fileName) {
                    if (fileName === undefined) {
                        console.log("No file selected");
                    } else {
                        console.log("file selected", fileName);
                        fs.writeFile(fileName, content, function (err) {
                            if (err) {
                                alert("An error ocurred creating the file " + err.message)
                            }

                            alert("The file has been succesfully saved");
                        });
                    }
                });
            }, false);

            document.getElementById('export_check_result').addEventListener('click', function () {
                var content = document.getElementById("check_result").value;
                dialog.showSaveDialog(function (fileName) {
                    if (fileName === undefined) {
                        console.log("No file selected");
                    } else {
                        console.log("file selected", fileName);
                        fs.writeFile(fileName, content, function (err) {
                            if (err) {
                                alert("An error ocurred creating the file " + err.message)
                            }

                            alert("The file has been succesfully saved");
                        });
                    }
                });
            }, false);

            function get_ssh_options(line) {
                let pos1 = line.indexOf(":")
                if (pos1 === -1) {
                    return undefined;
                }
                let user = line.substr(0, pos1);
                let pos2 = line.indexOf('@')
                if (pos2 === -1) {
                    return undefined;
                }
                let password = line.substr(pos1 + 1, pos2 - pos1 - 1)
                let host = line.substr(pos2 + 1)
                return {
                    host: host,
                    username: user,
                    password: password,
                    algorithms: {
                        cipher: ['aes128-cbc', 'blowfish-cbc', '3des-cbc', 'aes128-ctr', 'aes192-ctr', 'aes256-ctr', 'aes128-gcm', 'aes256-gcm'],
                        kex: ['diffie-hellman-group-exchange-sha1', 'diffie-hellman-group1-sha1', 'ecdh-sha2-nistp256', 'ecdh-sha2-nistp384', 'ecdh-sha2-nistp521', 'diffie-hellman-group-exchange-sha256', 'diffie-hellman-group14-sha1']
                    },
                    readyTimeout: 5000
                }
            }

            function get_telnet_options(line) {
                let pos1 = line.indexOf(":")
                if (pos1 === -1) {
                    return undefined;
                }
                let user = line.substr(0, pos1);
                let pos2 = line.indexOf('@')
                if (pos2 === -1) {
                    return undefined;
                }
                let password = line.substr(pos1 + 1, pos2 - pos1 - 1)
                let host = line.substr(pos2 + 1)
                return {
                    timeout: 5000,
                    execTimeout: 2000,
                    sendTimeout: 2000,
                    host: host,
                    username: user,
                    password: password,
                    shellPrompt: /(:~[^$]*\$|\w+>)\s*$/,
                    loginPrompt: /(login|username)[: ]*$/i,
                }
            }

            $('#manage_begin').on('click', function () {

                let lineString = $('#devices').val().trim();
                if (lineString.length === 0) {
                    alert('请添加设备')
                    return
                }

                document.getElementById("remote_results").value = '';
                document.getElementById("remote_error").innerHTML = '';

                $('#manage_begin').prop('disabled', true);

                let manageType = $('#manage_type').val();
                let arrayOfLines = lineString.match(/[^\r\n]+/g);
                const SSH2Promise = require('ssh2-promise');
                const Telnet = require('telnet-client')
                const fsextra = require('fs-extra');
                let num = arrayOfLines.length;
                let cmd = $('#execute_cmd').val();
                const path1 = app.getPath('userData');
                console.log(path1);
                if (manageType === 'ssh') {
                    cmd += '\nquit\n';
                    let ssh_folder = path.join(path1, 'ssh');
                    fsextra.removeSync(ssh_folder);
                    fsextra.ensureDirSync(ssh_folder);
                    for (let i = 0; i < num; i++) {
                        let config = get_ssh_options(arrayOfLines[i]);
                        if (config === undefined) {
                            num -= 1;
                            continue;
                        }
                        console.log(config);
                        let fd = fs.openSync(path.join(ssh_folder, config.host + '.txt'), 'w');
                        let ssh = new SSH2Promise(config);
                        (async function () {
                            try {
                                var socket = await ssh.shell();
                                socket.on('data', (data) => {
                                    console.log(data.toString('utf8'));
                                    fs.writeSync(fd, data);
                                    document.getElementById("remote_results").value += `${config.host}:`+ data.toString();
                                    //shell content will be available here
                                }).on('close', () => {
                                    console.log('close------');
                                    fs.closeSync(fd);
                                    num -= 1;
                                });
                                socket.write(cmd)
                            } catch (e) {
                                console.log('error', e);
                                fs.writeSync(fd, e.toString());
                                document.getElementById("remote_error").innerHTML += `${config.host}:` + '<span style="color: red">' + e.toString() + '</span>';
                                fs.closeSync(fd);
                                num -= 1;
                            }
                        }) ();

                    }

                    function check_status() {
                        if (num <= 0) {
                            $('#manage_begin').prop('disabled', false);
                            $('#current_path').val(ssh_folder);
                        } else {
                            setTimeout(function () {
                                check_status();
                            }, 3000)
                        }
                    }
                    check_status();

                } else if (manageType === 'telnet') {
                    let telnetFolder = path.join(path1, 'telnet');
                    fsextra.removeSync(telnetFolder);
                    fsextra.ensureDirSync(telnetFolder);
                    for (let i = 0; i < num; i++) {
                        let config = get_telnet_options(arrayOfLines[i]);
                        if (config === undefined) {
                            num -= 1;
                            continue;
                        }
                        console.log(config);
                        let fd = fs.openSync(path.join(telnetFolder, config.host + '.txt'), 'w');
                        (async function () {
                            let connection = new Telnet()
                            try {
                                await connection.connect(config)
                                let cmds = cmd.match(/[^\r\n]+/g);
                                for (let j = 0; j < cmds.length; j++) {
                                    let singleCmd = cmds[j]
                                    let res = await connection.exec(singleCmd)
                                    console.log('async result:', res)
                                    fs.writeSync(fd, `<hhhhhhtttttt> ${singleCmd}\n`)
                                    fs.writeSync(fd, res);
                                    document.getElementById("remote_results").value += `${config.host}: ${singleCmd}\n`+ res.toString();
                                }
                                num -= 1;
                                connection.destroy()
                                fs.closeSync(fd);
                            } catch (e) {
                                num -= 1;
                                connection.destroy()
                                console.log(`error ${e}`)
                                fs.writeSync(fd, e.toString());
                                fs.closeSync(fd);
                                document.getElementById("remote_error").innerHTML += `${config.host}:` + '<span style="color: red">' + e.toString() + '</span>';
                            }
                        })()
                    }
                    function check_status1() {
                        if (num <= 0) {
                            $('#manage_begin').prop('disabled', false);
                            $('#current_path').val(telnetFolder);
                        } else {
                            setTimeout(function () {
                                check_status1();
                            }, 3000)
                        }
                    }
                    check_status1();

                }



            });
        }

    });
</script>
</body>
</html>